{# templates/product/new.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}Create a new {{ type|capitalize }} ad{% endblock %}

{% block body %}
    <h2>Create a new {{ type|capitalize }} ad</h2>

    {{ form_start(form, {'attr': {'enctype': 'multipart/form-data'}}) }}

    {# Include the custom image upload partial – it handles the six boxes, previews, removals, etc. #}
    {% include 'product/_image_upload.html.twig' with { 'product': product|default(null), 'form': form } %}

    {# Mark the imageFiles field as rendered so form_rest() won’t output it again #}
    {% do form.imageFiles.setRendered() %}

    <div class="form-errors">
        {{ form_errors(form.imageFiles) }}
    </div>

    {{ form_rest(form) }}
    <button class="btn btn-primary">Save</button>
    {{ form_end(form) }}
    <a href="{{ path('app_dashboard') }}">Back to dashboard</a>

    {# --- Dynamic model fetching for car type (if applicable) --- #}
    {% if type == 'car' %}
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                const brandSelector = document.querySelector(".brand-selector");
                const modelSelector = document.querySelector(".model-selector");
                if (brandSelector && modelSelector) {
                    brandSelector.addEventListener("change", function () {
                        const selectedBrand = this.value;
                        modelSelector.innerHTML = '<option value="">Choose a model</option>';
                        if (!selectedBrand) return;
                        fetch('{{ path("get_car_models") }}', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            body: JSON.stringify({ brand: selectedBrand })
                        })
                            .then(response => response.json())
                            .then(models => {
                                if (models.error) {
                                    console.error(models.error);
                                    return;
                                }
                                for (const modelName of models) {
                                    let option = new Option(modelName, modelName);
                                    modelSelector.appendChild(option);
                                }
                            })
                            .catch(error => console.error("Error fetching models:", error));
                    });
                }
            });
        </script>
    {% endif %}
{% endblock %}
